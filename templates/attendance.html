{% extends "base.html" %}

{% block title %}Attendance - WorkZen{% endblock %}

{% block nav_attendance %}active{% endblock %}

{% block page_title %}Attendance{% endblock %}

{% block extra_css %}
<style>
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .stat-card {
        background: white;
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 20px;
        text-align: center;
    }

    .stat-value {
        font-size: 32px;
        font-weight: 700;
        color: var(--primary-color);
        margin-bottom: 5px;
    }

    .stat-label {
        font-size: 12px;
        color: var(--gray);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
    }

    .badge-success {
        background: #d4edda;
        color: #155724;
    }

    .badge-warning {
        background: #fff3cd;
        color: #856404;
    }

    .badge-danger {
        background: #f8d7da;
        color: #721c24;
    }
</style>
{% endblock %}

{% block content %}
<!-- Stats Overview -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-value">{{ attendance_records|length }}</div>
        <div class="stat-label">Total Records</div>
    </div>
    <div class="stat-card">
        <div class="stat-value" style="color: var(--success);">
            {{ attendance_records|selectattr('status', 'equalto', 'Present')|list|length }}
        </div>
        <div class="stat-label">Present</div>
    </div>
    <div class="stat-card">
        <div class="stat-value" style="color: var(--warning);">
            {{ attendance_records|selectattr('status', 'equalto', 'Late')|list|length }}
        </div>
        <div class="stat-label">Late</div>
    </div>
    <div class="stat-card">
        <div class="stat-value" style="color: var(--danger);">
            {{ attendance_records|selectattr('status', 'equalto', 'Absent')|list|length }}
        </div>
        <div class="stat-label">Absent</div>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h3 class="card-title">My Attendance Records</h3>
        {# Check if there is a record for today in the list #}
{% set today_record = attendance_records|selectattr('attendance_date', 'equalto', today_date)|first %}

{% if not today_record %}
    <a href="{{ url_for('mark_attendance') }}" class="btn btn-success">
        <i class="fas fa-sign-in-alt"></i> Check In
    </a>
{% elif not today_record.check_out %}
    <a href="{{ url_for('mark_attendance') }}" class="btn btn-warning">
        <i class="fas fa-sign-out-alt"></i> Check Out
    </a>
{% else %}
    <button class="btn btn-secondary" disabled>
        <i class="fas fa-check-circle"></i> Completed
    </button>
{% endif %}

    </div>
    <table class="table">
        <thead>
            <tr>
                <th>Date</th>
                <th>Check In</th>
                <th>Check Out</th>
                <th>Working Hours</th>
                <th>Status</th>
                <th>Remarks</th>
            </tr>
        </thead>
        <tbody>
            {% if attendance_records and attendance_records|length > 0 %}
                {% for record in attendance_records %}
                <tr>
                    <td>{{ record.attendance_date.strftime('%d %b %Y') if record.attendance_date else '-' }}</td>
                    <td>{{ record.check_in.strftime('%I:%M %p') if record.check_in else '-' }}</td>
                    <td>{{ record.check_out.strftime('%I:%M %p') if record.check_out else '-' }}</td>
                    <td>{{ '%.2f hours' % record.working_hours if record.working_hours else '-' }}</td>
                    <td>
                        {% if record.status == 'Present' %}
                            <span class="badge badge-success">Present</span>
                        {% elif record.status == 'Late' %}
                            <span class="badge badge-warning">Late</span>
                        {% else %}
                            <span class="badge badge-danger">Absent</span>
                        {% endif %}
                    </td>
                    <td>{{ record.remarks or '-' }}</td>
                </tr>
                {% endfor %}
            {% else %}
            <tr>
                <td colspan="6" style="text-align: center; padding: 40px; color: var(--gray);">
                    No attendance records found. Click "Mark Attendance" to check in.
                </td>
            </tr>
            {% endif %}
        </tbody>
    </table>
</div>

{% if user.role in ['ADMIN', 'HR_OFFICER', 'PAYROLL_OFFICER'] %}
<div class="card">
    <div class="card-header">
        <h3 class="card-title">Attendance Summary - November 2025</h3>
    </div>
    <table class="table">
        <thead>
            <tr>
                <th>Department</th>
                <th>Total Employees</th>
                <th>Present</th>
                <th>Absent</th>
                <th>Attendance %</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>Engineering</td>
                <td>50</td>
                <td>48</td>
                <td>2</td>
                <td style="color: var(--success); font-weight: 600;">96%</td>
            </tr>
            <tr>
                <td>Sales</td>
                <td>40</td>
                <td>36</td>
                <td>4</td>
                <td style="color: var(--success); font-weight: 600;">90%</td>
            </tr>
            <tr>
                <td>HR</td>
                <td>15</td>
                <td>14</td>
                <td>1</td>
                <td style="color: var(--success); font-weight: 600;">93%</td>
            </tr>
            <tr>
                <td>Marketing</td>
                <td>25</td>
                <td>24</td>
                <td>1</td>
                <td style="color: var(--success); font-weight: 600;">96%</td>
            </tr>
        </tbody>
    </table>
</div>
{% endif %}
{% endblock %}