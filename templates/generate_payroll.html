{% extends "base.html" %}

{% block title %}Generate Payroll - WorkZen{% endblock %}

{% block nav_payroll %}active{% endblock %}

{% block page_title %}Generate Payroll{% endblock %}

{% block extra_css %}
<style>
    .payroll-container {
        max-width: 1200px;
        margin: 0 auto;
    }

    .back-button {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        color: var(--primary-color);
        text-decoration: none;
        margin-bottom: 20px;
        font-weight: 500;
    }

    .back-button:hover {
        text-decoration: underline;
    }

    .warning-box {
        background: #fff3cd;
        border: 1px solid #ffc107;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 25px;
        display: flex;
        gap: 15px;
        align-items: start;
    }

    .warning-icon {
        font-size: 24px;
        color: #856404;
    }

    .warning-content {
        flex: 1;
    }

    .warning-title {
        font-weight: 700;
        color: #856404;
        margin-bottom: 8px;
    }

    .warning-text {
        font-size: 14px;
        color: #856404;
        line-height: 1.6;
    }

    .form-section {
        background: white;
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 30px;
        margin-bottom: 25px;
    }

    .section-title {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 20px;
        color: var(--dark);
        border-bottom: 2px solid var(--light-gray);
        padding-bottom: 10px;
    }

    .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
    }

    .form-group {
        display: flex;
        flex-direction: column;
    }

    .form-label {
        font-size: 14px;
        font-weight: 600;
        color: var(--dark);
        margin-bottom: 8px;
    }

    .form-input {
        padding: 12px 15px;
        border: 1px solid var(--border);
        border-radius: 8px;
        font-size: 14px;
    }

    .form-input:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }

    .form-help {
        font-size: 12px;
        color: var(--gray);
        margin-top: 5px;
    }

    .employee-list {
        max-height: 400px;
        overflow-y: auto;
        border: 1px solid var(--border);
        border-radius: 8px;
    }

    .employee-item {
        padding: 15px;
        border-bottom: 1px solid var(--border);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .employee-item:last-child {
        border-bottom: none;
    }

    .employee-info {
        flex: 1;
    }

    .employee-name {
        font-weight: 600;
        margin-bottom: 5px;
    }

    .employee-details {
        font-size: 12px;
        color: var(--gray);
    }

    .employee-salary {
        text-align: right;
        font-weight: 700;
        color: var(--primary-color);
    }

    .form-actions {
        display: flex;
        gap: 15px;
        justify-content: flex-end;
        padding-top: 20px;
        border-top: 1px solid var(--border);
    }

    .alert {
        padding: 15px 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        display: none;
    }

    .alert.show {
        display: block;
    }

    .alert.success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }

    .alert.error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }

    .summary-box {
        background: var(--light-gray);
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
    }

    .summary-row {
        display: flex;
        justify-content: space-between;
        padding: 10px 0;
        border-bottom: 1px solid var(--border);
    }

    .summary-row:last-child {
        border-bottom: none;
        font-weight: 700;
        font-size: 18px;
        padding-top: 15px;
        margin-top: 10px;
        border-top: 2px solid var(--border);
    }

    .summary-label {
        color: var(--dark);
    }

    .summary-value {
        font-weight: 600;
        color: var(--primary-color);
    }

    .loading {
        display: none;
        text-align: center;
        padding: 20px;
    }

    .loading.show {
        display: block;
    }

    .checkbox-group {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 15px;
        background: var(--light-gray);
        border-radius: 8px;
        margin-bottom: 20px;
    }

    .checkbox-group input[type="checkbox"] {
        width: 20px;
        height: 20px;
        cursor: pointer;
    }

    .checkbox-group label {
        margin: 0;
        cursor: pointer;
        font-weight: 500;
    }
</style>
{% endblock %}

{% block content %}
<div class="payroll-container">
    <a href="{{ url_for('payroll') }}" class="back-button">
        <i class="fas fa-arrow-left"></i> Back to Payroll
    </a>

    <!-- Warning Box -->
    <div class="warning-box">
        <div class="warning-icon">⚠️</div>
        <div class="warning-content">
            <div class="warning-title">Important: Payroll Generation</div>
            <div class="warning-text">
                This will generate payslips for all active employees for the selected month. 
                Payslips are calculated based on attendance records, basic salary, and deductions. 
                Make sure all attendance records are updated before generating payroll.
            </div>
        </div>
    </div>

    <div id="alertBox" class="alert"></div>
    <div id="loadingBox" class="loading">
        <i class="fas fa-spinner fa-spin"></i> Generating payroll... This may take a moment.
    </div>

    <form id="generatePayrollForm" onsubmit="handleGenerate(event)">
        <!-- Payroll Settings -->
        <div class="form-section">
            <h3 class="section-title">Payroll Settings</h3>
            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label">Payroll Month <span style="color: var(--danger);">*</span></label>
                    <input type="month" name="payroll_month" class="form-input" required>
                    <span class="form-help">Select the month for which you want to generate payroll</span>
                </div>
                <div class="form-group">
                    <label class="form-label">Department Filter</label>
                    <select name="department" class="form-input">
                        <option value="">All Departments</option>
                        {% for dept in departments %}
                        <option value="{{ dept }}">{{ dept }}</option>
                        {% endfor %}
                    </select>
                    <span class="form-help">Optional: Generate payroll for specific department only</span>
                </div>
            </div>

            <div class="checkbox-group">
                <input type="checkbox" name="include_inactive" id="includeInactive">
                <label for="includeInactive">Include inactive employees</label>
            </div>
        </div>

        <!-- Employee Preview -->
        <div class="form-section">
            <h3 class="section-title">
                Employees to be Processed
                <span style="font-weight: normal; font-size: 14px; color: var(--gray);">
                    ({{ employees|length }} employees)
                </span>
            </h3>
            
            {% if employees and employees|length > 0 %}
            <div class="employee-list">
                {% for employee in employees %}
                <div class="employee-item">
                    <div class="employee-info">
                        <div class="employee-name">{{ employee.full_name }}</div>
                        <div class="employee-details">
                            {{ employee.login_id }} • {{ employee.department or 'No Department' }} • 
                            {{ employee.job_position or 'No Position' }}
                        </div>
                    </div>
                    <div class="employee-salary">
                        ₹{{ "{:,.2f}".format(employee.basic_salary) if employee.basic_salary else '0.00' }}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p style="text-align: center; padding: 40px; color: var(--gray);">
                No active employees found
            </p>
            {% endif %}
        </div>

        <!-- Summary -->
        <div class="form-section">
            <h3 class="section-title">Payroll Summary</h3>
            <div class="summary-box">
                <div class="summary-row">
                    <span class="summary-label">Total Employees</span>
                    <span class="summary-value">{{ employees|length }}</span>
                </div>
                <div class="summary-row">
                    <span class="summary-label">Total Basic Salary</span>
                    <span class="summary-value">₹{{ "{:,.2f}".format(total_basic_salary) }}</span>
                </div>
                <div class="summary-row">
                    <span class="summary-label">Estimated Gross Salary</span>
                    <span class="summary-value">₹{{ "{:,.2f}".format(estimated_gross) }}</span>
                </div>
                <div class="summary-row">
                    <span class="summary-label">Estimated Deductions</span>
                    <span class="summary-value">₹{{ "{:,.2f}".format(estimated_deductions) }}</span>
                </div>
                <div class="summary-row">
                    <span class="summary-label">Estimated Net Payout</span>
                    <span class="summary-value">₹{{ "{:,.2f}".format(estimated_net) }}</span>
                </div>
            </div>
        </div>

        <!-- Actions -->
        <div class="form-section">
            <div class="form-actions">
                <a href="{{ url_for('payroll') }}" class="btn btn-outline">Cancel</a>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-cog"></i> Generate Payroll
                </button>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Set default month to current month
    const today = new Date();
    const currentMonth = today.toISOString().slice(0, 7);
    document.querySelector('input[name="payroll_month"]').value = currentMonth;

    async function handleGenerate(event) {
        event.preventDefault();
        
        const form = event.target;
        const formData = new FormData(form);
        
        // Confirm before generating
        if (!confirm('Are you sure you want to generate payroll for the selected month? This action cannot be undone.')) {
            return;
        }
        
        // Show loading
        document.getElementById('loadingBox').classList.add('show');
        document.getElementById('alertBox').classList.remove('show');
        
        try {
            // Convert form data to JSON
            const payrollMonth = formData.get('payroll_month') + '-01'; // Add day to make it a valid date
            
            const response = await fetch('/api/payroll/generate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    payroll_month: payrollMonth,
                    department: formData.get('department') || null,
                    include_inactive: formData.get('include_inactive') === 'on'
                })
            });
            
            const result = await response.json();
            
            document.getElementById('loadingBox').classList.remove('show');
            
            if (response.ok) {
                // Show success message
                const alertBox = document.getElementById('alertBox');
                alertBox.className = 'alert success show';
                alertBox.textContent = result.message || 'Payroll generated successfully!';
                
                // Redirect after 2 seconds
                setTimeout(() => {
                    window.location.href = '/payroll';
                }, 2000);
            } else {
                // Show error message
                const alertBox = document.getElementById('alertBox');
                alertBox.className = 'alert error show';
                alertBox.textContent = result.error || 'Failed to generate payroll';
            }
        } catch (error) {
            document.getElementById('loadingBox').classList.remove('show');
            const alertBox = document.getElementById('alertBox');
            alertBox.className = 'alert error show';
            alertBox.textContent = 'An error occurred. Please try again.';
            console.error('Error:', error);
        }
    }
</script>
{% endblock %}